name: Fetch Proxies

on:
  schedule:
    - cron: '0 */6 * * *'  # Run every 6 hours
  workflow_dispatch:  # Allow manual trigger
  push:
    branches:
      - main

permissions:
  contents: write  # This allows the workflow to push changes

jobs:
  fetch-proxies:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Fetch proxy data
        run: |
          curl -s https://cdn.jsdelivr.net/gh/proxifly/free-proxy-list@main/proxies/protocols/socks5/data.txt -o proxies.txt

      - name: Process proxies
        run: |
          python3 << 'EOF'
          import json
          from datetime import datetime, timezone

          proxies = []
          
          try:
              with open('proxies.txt', 'r') as f:
                  for line in f:
                      line = line.strip()
                      if line and ':' in line:
                          parts = line.split(':')
                          if len(parts) >= 2:
                              ip = parts[0].strip()
                              port = parts[1].strip()
                              # Validate IP and port
                              if ip and port.isdigit():
                                  proxies.append({
                                      'ip': ip,
                                      'port': port
                                  })
          except Exception as e:
              print(f"Error reading proxies: {e}")

          # Create JSON output
          output = {
              'lastUpdate': datetime.now(timezone.utc).isoformat(),
              'count': len(proxies),
              'proxies': proxies
          }

          with open('proxies.json', 'w') as f:
              json.dump(output, f, indent=2)

          print(f"Successfully processed {len(proxies)} proxies")
          EOF

      - name: Commit and push if changed
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add proxies.json
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update proxies [$(date)]" && git push)